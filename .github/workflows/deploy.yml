name: Deploy Competency Backend to DO

on:
  push:
    branches:
      - main  # deploy on pushes to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout your repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup SSH key for server access
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      # 3Ô∏è‚É£ Deploy via SSH to your DO/Hetzner server
      - name: Deploy to DigitalOcean
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          echo "üöÄ Starting deployment on server..."
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "üíª Pulling latest code from GitHub"
          git fetch origin
          git reset --hard origin/main

          echo "üì¶ Installing dependencies"
          npm install

          echo "üîß Building project"
          npm run build

          echo "‚ö° Restarting PM2 process"
          pm2 restart competency-api --update-env
          pm2 save

          echo "‚úÖ Deployment complete!"
          EOF
